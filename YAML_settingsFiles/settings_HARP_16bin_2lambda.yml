
input:
    driver: sdata
    file: bench.sdat


output:
    segment:
        function: classic
        stream: bench_inversionRslts.txt 
        
retrieval:
    general:
        path_to_internal_files: "/usr/local/share/grasp/kernels/"
#        path_to_internal_files: "/opt/grasp-0.8/share/grasp/kernels/"
        
    convergence:
        stop_before_performing_retrieval: true
        minimization_convention: logarithm
        threshold_for_stopping: 1.0e-3
        maximum_iterations_for_stopping: 20
        maximum_iterations_of_Levenberg-Marquardt: 20
        threshold_for_stopping_Q_iterations:  1.0e-5
        scale_for_finite_difference:          1.0e-3 
        normal_system_solver:       sparse_matrix_solver
        shift_for_applying_logarithm_to_negative_values: 1.1
        
    regime_of_measurement_fitting:
#        polarization: polarized_reflectance # P
#        polarization: degree_of_polarization # PoI [CHANGED FROM linear_polarization IN V0.8.1]
        polarization: absolute_polarization_components # Q, U
            
    regime_of_multipixel_constraints: 
        inversion_regime: single_pixel   

    noises:
        noise[1]:
            standard_deviation_synthetic: 0.0
            error_type:   relative
            standard_deviation:  0.03
            measurement_type[1]:
                type: I
                index_of_wavelength_involved: [ 1, 2]
        noise[2]:
            standard_deviation_synthetic: 0.0
            error_type:  absolute
            standard_deviation:  0.005
            measurement_type[1]:
                type: Q
                index_of_wavelength_involved: [ 1, 2]
            measurement_type[2]:
                type: U
                index_of_wavelength_involved: [ 1, 2]

    radiative_transfer:
        number_of_layers: 50 #50 -> 100, no meaningful improvement
        aerosol_profile_vertical_type:    exponential
#        molecular_profile_vertical_type:   exponential 
        molecular_profile_vertical_type:   no_rayleigh 
        absolute_error_rt_calculations: 0.000001 # this helps, at least once quadratures_for_fourier_expansion is sufficiently high, max of default allowed range
#        reference_plane_for_polarization:   meridian
        reference_plane_for_polarization:   principal_plane
        simulating_observation:
#            order_of_scattering: single_scattering
            order_of_scattering: single_scattering
            number_of_gaussian_quadratures_for_expansion_coefficients:  20 # 41 is max, this should have no effect w/o aerosol
            number_of_guassian_quadratures_for_fourier_expansion_coefficients:  50 # big diff here, diminishing returns after 20 though
            number_of_fourier_expansion_coefficients:  10 # 4->10 makes very little difference in BRDF+BPDF case, nothing after that
        simulating_derivatives:
            order_of_scattering: derivatives
            number_of_gaussian_quadratures_for_expansion_coefficients:  15
            number_of_guassian_quadratures_for_fourier_expansion_coefficients:   4
            number_of_fourier_expansion_coefficients:   4

    phase_matrix:
        size_binning_method_for_triangle_bins: logarithm
        number_of_elements: 4 # >4 will print the corresponding PM elements but DOLP=0
        kernels_folder: "KERNELS_BASE/"
        radius:
            mode[1]:
                min: 0.05
                max: 0.5
#                bins: [ ]
#    product_configuration:
#        wavelength_indices_for_angstrom: [4, 5]
#        wavelength_indices_for_ndvi: [4, 5]

    products:                   
        aerosol:
            chemistry: false
            lidar: false                            
            optical_properties: true                
            phase_matrix: false                      
            refractive_index: true                 
            theoretical_bimodal_extinction: false    
            theoretical_bimodal_parameters: true  
            particulate_matter: false
            type: false
        error_estimation:
            aerosol:
                lidar: false            
                optical_properties: false
            parameters: false               
        forcing:
            broadband_flux: false                    
            forcing: false                           
        retrieval:
            fitting: true                       
            parameters: true                      
            residual: true                        
        surface: true                                   

    debug:
        additional_information: false
        verbose: true

    constraints:    
        characteristic[1]:
            type: surface_water_CxMnk_iso_noPol
            retrieved: true
            mode[1]:    
                initial_guess:                       #1      #2      #3      #4      #5      #6       
                    value:                          [0.00000000000000001, 0.00000000000000001]
                    min:                             [0.000000000000000001, 0.000000000000000001]
                    max:                            [0.05, 0.05]
                    index_of_wavelength_involved:   [1, 2]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 1.0e-3
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    1
                       lagrange_multiplier_of_X_variability: 1.0e-3                        
                       derivative_order_of_Y_variability:    1
                       lagrange_multiplier_of_Y_variability: 1.0e-3
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 1.0e-3

            mode[2]:
                initial_guess:                       #1      #2      #3      #4      #5      #6       
                    value:                          [0.9999999999999999, 0.9999999999999999]
                    min:                             [0.60, 0.60]
                    max:                            [1.0000, 1.0000]
                    index_of_wavelength_involved:   [1, 2]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 10.0e-0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    1
                       lagrange_multiplier_of_X_variability: 1.0e-3                        
                       derivative_order_of_Y_variability:    1
                       lagrange_multiplier_of_Y_variability: 1.0e-3
                       derivative_order_of_T_variability:    0
                       lagrange_multiplier_of_T_variability: 1.0e-3

            mode[3]:
                initial_guess:                       #1      #2      #3      #4      #5      #6       
                    value:                          [0.0143, 0.0143]
                    min:                            [0.0015, 0.0015]
                    max:                            [0.1, 0.1]
                    index_of_wavelength_involved:   [ 1, 2]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 10.0e-0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    1
                       lagrange_multiplier_of_X_variability: 1.0e-3                        
                       derivative_order_of_Y_variability:    1
                       lagrange_multiplier_of_Y_variability: 1.0e-3
                       derivative_order_of_T_variability:    0
                       lagrange_multiplier_of_T_variability: 1.0e-3

        characteristic[2]: 
            type: surface_land_brdf_ross_li # NEEDS TO GO ABOVE BPDF
            retrieved: true
            mode[1]:    #ISO
                initial_guess:                       # wvls = [0.470, 0.865]
                    value:                          [0.000000000001,0.000000000001]     
                    min:                             [0.00000000000001,0.00000000000001]
                    max:                            [0.9,0.9]
#                    value:                          [0.13899999856948853, 0.338357150554657]     
#                    min:                             [0.0001, 0.0001]
#                    max:                            [0.9, 0.9]
                    index_of_wavelength_involved:   [1, 2]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    0
                       lagrange_multiplier_of_X_variability: 1.0e-3                        
                       derivative_order_of_Y_variability:    0
                       lagrange_multiplier_of_Y_variability: 1.0e-3
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 1.0e-0                            

            mode[2]:  # VOL
                initial_guess:                       
                    value:                          [0.43884894251823425,  0.5107452273368835]    
                    min:                             [0.0001, 0.0001]
                    max:                            [0.9, 0.9]
                    index_of_wavelength_involved:   [1, 2]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    0
                       lagrange_multiplier_of_X_variability: 1.0e-3                        
                       derivative_order_of_Y_variability:    0
                       lagrange_multiplier_of_Y_variability: 1.0e-3
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 1.0e-0
                       
            mode[3]:  #GEOM
                initial_guess:                         
                    value:                          [0.1366906464099884, 0.12526914477348328]
                    min:                             [0.0001, 0.0001]
                    max:                            [0.9, 0.9]
                    index_of_wavelength_involved:   [1, 2]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    0
                       lagrange_multiplier_of_X_variability: 1.0e-3                        
                       derivative_order_of_Y_variability:    0
                       lagrange_multiplier_of_Y_variability: 1.0e-3
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 1.0e-0                            

        characteristic[3]:
            type: surface_land_polarized_maignan_breon
            retrieved: true
            mode[1]: 
                initial_guess:                      
                    value:                          [0.0000000002, 0.0000000002]
                    min:                             [0.0000000001, 0.0000000001]
                    max:                            [8.0, 8.0]
#                    value:                          [5.3208382787]
#                    min:                            [1.5]
#                    max:                            [8.0]
                    index_of_wavelength_involved:   [1, 2]

        characteristic[4]:
            type: real_part_of_refractive_index_spectral_dependent
            retrieved: false
            mode[1]:
                initial_guess:                       #1         #2        #3        #4        #5        #6       
                    value:                          [1.3552813529968262, 1.3598064184188843]
                    min:                            [1.33, 1.33]
                    max:                            [1.7, 1.7]
                    index_of_wavelength_involved:   [1, 2] 
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    1
                       lagrange_multiplier_of_X_variability: 1.0e-1                        
                       derivative_order_of_Y_variability:    1
                       lagrange_multiplier_of_Y_variability: 1.0e-1                     
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 2.0e-2                                               
                       
        characteristic[5]: 
            type: size_distribution_triangle_bins
            retrieved: false
            mode[1]: 
                initial_guess:                         #these are regular and 10X PSD, scaled to match scattering AOD (i.e. AOD/SSA)
#                      value:                          [0.00024934, 0.00032081, 0.00041882, 0.00053509, 0.00068027, 0.00086469, 0.00107891, 0.00135146, 0.00167552, 0.00204874, 0.00251761, 0.00304956, 0.00366994, 0.00440135, 0.005217  , 0.00616458, 0.00722617, 0.00839333, 0.00971741, 0.01114832, 0.0127059 , 0.01438423, 0.01616833, 0.01805086, 0.02000504, 0.02204738, 0.02408151, 0.02614927, 0.02822318, 0.03018357, 0.03212969, 0.0339245 , 0.03555405, 0.03710616, 0.03831351, 0.03936238, 0.04020916, 0.02938995, 0.01663062, 0.00400194]
#                      value:                            [0.00249342, 0.0032081 , 0.00418816, 0.00535092, 0.00680268, 0.00864688, 0.01078911, 0.01351463, 0.01675511, 0.02048741, 0.02517613, 0.03049564, 0.03669942, 0.0440135 , 0.05216999, 0.06164588, 0.07226169, 0.0839333 , 0.0971741 , 0.11148325, 0.12705895, 0.14384228, 0.16168333, 0.18050866, 0.20005047, 0.22047379, 0.24081507, 0.26149264, 0.28223179, 0.30183567, 0.32129685, 0.33924495, 0.35554051, 0.37106161, 0.38313503, 0.39362375, 0.40209163, 0.29389943, 0.16630614, 0.0400194 ]
                      value:                            [2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13, 2e-13]
                      min:                               [1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13, 1e-13]
                      max:                             [5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0, 5.0]
                      index_of_wavelength_involved:   [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    1
                       lagrange_multiplier_of_X_variability: 1.0e-1                        
                       derivative_order_of_Y_variability:    1
                       lagrange_multiplier_of_Y_variability: 1.0e-1                     
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 5.0e-4
                                                
        characteristic[6]:
            type: imaginary_part_of_refractive_index_spectral_dependent
            retrieved: false
            mode[1]:
                initial_guess:                       #1        #2        #3        #4        #5        #6    
                    value:                          [6.2871e-07, 6.007585398037918e-07]
                    min:                            [1e-10, 1e-10]
                    max:                            [0.1, 0.1]
                    index_of_wavelength_involved:   [1, 2]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 1
                        lagrange_multiplier: 0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    1
                       lagrange_multiplier_of_X_variability: 1.0e-1                        
                       derivative_order_of_Y_variability:    1
                       lagrange_multiplier_of_Y_variability: 1.0e-1                     
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 2.0e-2

        characteristic[7]: 
            type: sphere_fraction
            retrieved: false
            mode[1]:
                initial_guess:                      #1      
                    value:                          [0.99999998   ]
                    min:                            [0.99999997 ]
                    max:                            [0.99999999]
                    index_of_wavelength_involved:   [0     ]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 0
                        lagrange_multiplier: 0.0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    1
                       lagrange_multiplier_of_X_variability: 1.0e-1                        
                       derivative_order_of_Y_variability:    1
                       lagrange_multiplier_of_Y_variability: 1.0e-1                     
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 1.0e-2

        characteristic[8]: 
            type: vertical_profile_parameter_height
            retrieved: false
            mode[1]:
                initial_guess:                      #1          
                    value:                          [1000.0 ]
                    min:                            [10.0   ] 
                    max:                            [10000.0 ]
                    index_of_wavelength_involved:   [0      ]
                single_pixel:
                    smoothness_constraints:
                        difference_order: 0
                        lagrange_multiplier: 0
                multi_pixel:
                   smoothness_constraints:
                       derivative_order_of_X_variability:    1
                       lagrange_multiplier_of_X_variability: 1.0e-1                        
                       derivative_order_of_Y_variability:    1
                       lagrange_multiplier_of_Y_variability: 1.0e-1                     
                       derivative_order_of_T_variability:    1
                       lagrange_multiplier_of_T_variability: 1.0e-2
                         
settings:
   strict: true

